# 尖度誤差分析レポート

## 概要

ベンチマーク結果から、尖度誤差が大きくなる原因を分析しました。

## 主要な発見

### 1. K値（成分数）の影響が最も大きい

- **K=3**: 平均誤差 23.66%、最大誤差 26.66%
  - すべてのケース（8/8）で誤差が10%を超える
  - 自由度不足が主な原因（5つのモーメント制約 vs 3つの重みパラメータ）

- **K=5**: 平均誤差 5.05%、最大誤差 10.22%
  - 1ケースのみ誤差が10%を超える

- **K≥10**: 平均誤差 < 2%
  - すべてのケースで誤差が10%未満

**結論**: Kが小さいほど尖度誤差が大きくなる。K≥5を推奨。

### 2. 真の尖度が0に近い場合の誤差増大

以下のパラメータセットで真の尖度が0に非常に近い：

- **Parameter Set 4** (rho=0.5, mu_x=mu_y=0, sigma_x=sigma_y=1):
  - 真の尖度: -0.003133（ほぼ0）
  - 相対誤差が不安定になる（分母が小さいため）

- **Parameter Set 5** (rho=0.95, mu_x=mu_y=0, sigma_x=sigma_y=1):
  - 真の尖度: -0.013491（ほぼ0）
  - 同様に相対誤差が不安定

**結論**: XとYが同じ分布で相関が中程度〜高い場合、max(X,Y)の尖度は0に近くなる傾向がある。この場合、相対誤差の計算が不安定になる。

### 3. PDF誤差との相関

- PDF誤差と尖度誤差の相関係数: 0.5665（中程度の正の相関）
- 大きなPDF誤差は、大きな尖度誤差と関連している可能性がある

### 4. 目的モードによる違い

- **PDF-only mode**: 平均誤差 6.94%、最大誤差 23.03%
- **Moments mode**: 平均誤差 5.56%、最大誤差 26.66%
  - Moments modeの方が平均誤差は小さいが、最大誤差は大きい
  - K=3の場合、Moments modeでも大きな誤差が発生

### 5. グリッド解像度の影響

- 64-512 pointsの範囲では、グリッド解像度による誤差への影響は小さい
- すべての解像度で同様の誤差パターンが観察される

## 詳細分析

### K値と誤差の関係（詳細）

| K | 平均誤差 | 中央値誤差 | 最大誤差 | 誤差>10%のケース | 自由度 |
|---|---------|-----------|---------|----------------|--------|
| 3 | 23.66% | 23.71% | 26.66% | 8/8 (100%) | -2 (不足) |
| 4 | 8.32% | 8.18% | 15.28% | 4/8 (50%) | -1 (不足) |
| 5 | 5.05% | 4.99% | 10.22% | 1/8 (12.5%) | 0 (均衡) |
| 10 | 1.28% | 1.29% | 2.19% | 0/8 (0%) | +5 (余裕) |
| 15 | 0.42% | 0.34% | 0.92% | 0/8 (0%) | +10 (余裕) |
| 20 | 0.84% | 0.77% | 1.13% | 0/8 (0%) | +15 (余裕) |

**観察**: 
- K=3からK=4への増加で誤差が約65%改善（23.66% → 8.32%）
- K=4からK=5への増加で誤差が約39%改善（8.32% → 5.05%）
- K=3からK=5への増加で誤差が約79%改善（23.66% → 5.05%）
- K=4はK=3とK=5の中間的な性能を示す（自由度が-1）
- K≥10では誤差は2%未満

### 目的モード別のK値による誤差

**PDF-only mode**:
- K=3: 22.10%
- K=4: 14.81%（すべてのケースで誤差>10%）
- K=5: 9.86%
- K≥10: <2%

**Moments mode**:
- K=3: 25.22%（PDF modeより大きい）
- K=4: 1.82%（PDF modeより大幅に小さい、誤差改善率87.7%）
- K=5: 0.24%（PDF modeより大幅に小さい）
- K≥10: <1%

**重要な発見**: 
- Moments modeはK≥4で非常に効果的
- K=3では逆に悪化する（自由度不足のため）
- K=4でもMoments modeは誤差を87.7%削減（14.81% → 1.82%）
- K=4のMoments modeでは、すべてのケースで誤差<5%

### 相関と真の尖度の関係

XとYが同じ分布（μ_x=μ_y=0, σ_x=σ_y=1）の場合：

| 相関 (rho) | 真の尖度 | カテゴリ |
|-----------|---------|---------|
| 0.0 | 正の値（中程度） | Normal |
| 0.5 | -0.003133 | Very small (<0.01) |
| 0.9 | 正の値（中程度） | Normal |
| 0.95 | -0.013491 | Small (0.01-0.1) |
| 0.99 | 0に近い | Very small |

**結論**: 中程度の相関（ρ≈0.5）で尖度が0に近くなる傾向がある。

## K=4の詳細分析結果

### 全体統計
- **平均誤差**: 8.32%（K=3の35%、K=5の165%）
- **中央値誤差**: 8.18%
- **最大誤差**: 15.28%
- **誤差>10%のケース**: 4/8（50%）

### 目的モード別の詳細

**PDF-only mode** (4ケース):
- 平均誤差: 14.81%
- すべてのケースで誤差>10%
- グリッド解像度による影響は小さい（14.51%〜15.28%）

**Moments mode** (4ケース):
- 平均誤差: 1.82%
- すべてのケースで誤差<5%
- PDF modeと比較して87.7%の誤差削減
- PDF誤差は増加するが（0.009396 → 0.028093）、尖度誤差は大幅に改善

### 自由度の観点から

- **K=3**: 自由度-2（3パラメータ vs 5制約）→ 誤差23.66%
- **K=4**: 自由度-1（4パラメータ vs 5制約）→ 誤差8.32%
- **K=5**: 自由度0（5パラメータ vs 5制約）→ 誤差5.05%

**結論**: K=4でも自由度が1つ不足しているが、K=3と比較して大幅に改善。Moments modeを使用することで、K=4でも実用的な精度が得られる。

## 推奨事項

1. **K≥4を使用**: K=3は避けるべき（特にMoments mode）
2. **K=4でのMoments mode推奨**: K=4でもMoments modeを使用することで、尖度誤差を1.82%まで削減可能
3. **K≥5が理想的**: より高い精度が必要な場合はK≥5を推奨
4. **真の尖度が0に近い場合の注意**: 相対誤差の解釈に注意が必要
5. **閾値ベースの相対誤差計算**: 真の値が0に近い場合、閾値（0.01）を分母として使用（実装済み）
6. **Moments modeの使用**: K≥4の場合、Moments modeは尖度誤差を大幅に改善する
7. **パラメータセットの選択**: 中程度の相関（ρ≈0.5）で同じ分布の場合、尖度が0に近くなる可能性を考慮

## 統計サマリー

- 総ケース数: 40
- 誤差 > 10%: 9ケース（22.5%）
- 平均誤差: 6.25%
- 中央値誤差: 0.90%
- 最大誤差: 26.66%

## 誤差分布

- 75パーセンタイル: 9.76%
- 90パーセンタイル: 23.17%
- 95パーセンタイル: 24.68%

大部分のケース（約75%）で誤差は10%未満ですが、K=3のケースと真の尖度が0に近いケースで大きな誤差が発生しています。

