# EM法とLP法の比較と推奨設定

## 実行結果サマリー

### 1. 実行時間比較

| 方法 | 平均実行時間 | 中央値 | 範囲 |
|------|------------|--------|------|
| **EM (PDF-only)** | **0.0074s** | 0.0062s | 0.0043-0.0144s |
| **EM (Moments)** | **0.0079s** | 0.0069s | 0.0048-0.0148s |
| LP (PDF) | 0.0161s | 0.0091s | 0.0016-0.1073s |
| LP (Moments) | 0.1499s | 0.0749s | 0.0051-0.9773s |

**結論**: EM法がLP法より約2-19倍高速。

### 2. PDF誤差比較（L∞）

| 方法 | 平均誤差 | 中央値 |
|------|---------|--------|
| **EM (PDF-only)** | **0.0086** | 0.0084 |
| LP (Moments) | 0.0100 | 0.0100 |
| EM (Moments) | 0.0158 | 0.0108 |
| LP (PDF) | 0.0405 | 0.0052 |

**結論**: EM法（PDF-only）が最も優れたPDF精度を提供。

### 3. モーメント誤差比較（相対誤差%）

| 方法 | 平均 | 標準偏差 | 歪度 | **尖度** |
|------|------|---------|------|---------|
| **EM (Moments)** | 0.0167% | 0.0195% | 0.1063% | **0.88%** |
| LP (Moments) | 0.0326% | 0.3452% | 0.2662% | 2.29% |
| EM (PDF-only) | 0.0026% | 0.0058% | 0.9371% | 5.48% |
| LP (PDF) | 16.74% | 3.37% | 29.71% | 48.12% |

**結論**: EM法（Moments）が最も優れたモーメント精度を提供。

### 4. 尖度誤差の詳細比較

| 方法 | 平均誤差 | 中央値 | 最大誤差 |
|------|---------|--------|---------|
| **EM (Moments)** | **0.88%** | 0.82% | 1.85% |
| LP (Moments) | 2.29% | 0.00% | 13.63% |
| EM (PDF-only) | 5.48% | 2.01% | 15.28% |
| LP (PDF) | 48.12% | 26.27% | 158.35% |

**結論**: EM法（Moments）が最も優れた尖度精度を提供。

## 用途別推奨設定

### A. 高精度が必要（モーメント一致が重要）

**推奨: EM法（Moments mode）with K≥5**

- **理由**: 
  - 尖度誤差が最小（0.88%）
  - すべてのモーメントで高い精度
  - 実行時間も短い（0.0079s）

- **設定例**:
  ```json
  {
    "method": "em",
    "K": 5,
    "use_moment_matching": true,
    "qp_mode": "hard",
    "soft_lambda": 1e4
  }
  ```

### B. 高速実行が必要

**推奨: EM法（PDF-only mode）**

- **理由**:
  - 最も高速（平均0.0074s）
  - PDF精度も高い（0.0086）
  - モーメント精度は中程度だが、多くの用途で十分

- **設定例**:
  ```json
  {
    "method": "em",
    "K": 5,
    "use_moment_matching": false
  }
  ```

### C. 最高のPDF近似が必要

**推奨: EM法（PDF-only mode）with K≥10**

- **理由**:
  - 最低のPDF誤差（0.0086）
  - 実行時間も短い
  - PDF形状の再現性が高い

- **設定例**:
  ```json
  {
    "method": "em",
    "K": 10,
    "use_moment_matching": false
  }
  ```

### D. バランスの取れた性能（PDF + モーメント）

**推奨: EM法（Moments mode）with K≥5**

- **理由**:
  - PDF誤差: 0.0158（許容範囲）
  - モーメント誤差: すべて<1%
  - 実行時間: 0.0079s（高速）

- **設定例**:
  ```json
  {
    "method": "em",
    "K": 5,
    "use_moment_matching": true,
    "qp_mode": "hard"
  }
  ```

### E. 大規模な辞書を使用する場合

**注意**: LP法のMomentsモードは実行速度の都合によりベンチマークでスキップされています。実装は可能ですが、ベンチマークでは評価されていません。

**推奨: LP法（Raw Moments mode）with 大きなL**

- **理由**:
  - 大きな辞書サイズ（K×L）で柔軟性が高い
  - Raw Moments modeでモーメント精度が改善
  - **注意**: 多くのケースで実行不可能な場合がある

- **設定例**:
  ```json
  {
    "method": "lp",
    "K": 10,
    "L": 10,
    "lp_params": {
      "objective_mode": "raw_moments",
      "solver": "highs"
    }
  }
  ```

## 方法別の詳細推奨

### EM法

#### PDF-only mode
- **適用場面**: 
  - PDF形状の再現が主目的
  - 高速処理が必要
  - モーメント精度は中程度で十分

- **推奨設定**:
  - K: 5-10
  - use_moment_matching: false

- **性能**:
  - 実行時間: 0.0074s
  - PDF誤差: 0.0086
  - 尖度誤差: 5.48%

#### Moments mode
- **適用場面**:
  - モーメント精度が重要
  - 統計的性質の正確な再現が必要
  - PDF精度は中程度で許容可能

- **推奨設定**:
  - K: ≥5（推奨: 5-10）
  - use_moment_matching: true
  - qp_mode: "hard"
  - soft_lambda: 1e4

- **性能**:
  - 実行時間: 0.0079s
  - PDF誤差: 0.0158
  - 尖度誤差: 0.88%

### LP法

#### PDF mode
- **適用場面**:
  - 大きな辞書サイズが必要
  - PDF精度が主目的
  - モーメント精度は重要でない

- **推奨設定**:
  - K: 10-20
  - L: 10-15
  - objective_mode: "pdf"

- **性能**:
  - 実行時間: 0.0161s
  - PDF誤差: 0.0405（中央値: 0.0052）
  - 尖度誤差: 48.12%（モーメント精度は低い）

#### Raw Moments mode
- **適用場面**:
  - 大きな辞書サイズが必要
  - モーメント精度も重要
  - **注意**: 多くのケースで実行不可能な場合がある

- **推奨設定**:
  - K: 10-15
  - L: 10
  - objective_mode: "raw_moments"
  - solver: "highs"

- **性能**:
  - 実行時間: 変動が大きい
  - PDF誤差: 変動が大きい
  - 多くのケースで失敗

**注意**: LP法のMomentsモードは実行速度の都合によりベンチマークでスキップされています。

## K値による推奨

| K | PDF-only mode | Moments mode | 推奨用途 |
|---|--------------|--------------|---------|
| 3 | ❌ 非推奨 | ❌ 非推奨 | 使用しない |
| 4 | ⚠️ 注意 | ✅ 推奨 | Moments modeで使用可能（尖度誤差~1.8%） |
| 5 | ✅ 推奨 | ✅✅ 強く推奨 | 標準的な設定 |
| 10 | ✅✅ 推奨 | ✅✅ 推奨 | 高精度が必要な場合 |
| ≥15 | ✅✅ 推奨 | ✅✅ 推奨 | 最高精度が必要な場合 |

## 総合推奨ランキング

### 1. 最も推奨される設定

**EM法（Moments mode）with K=5**

- 実行時間: 0.0079s（高速）
- PDF誤差: 0.0158（良好）
- 尖度誤差: 0.88%（優秀）
- すべてのモーメントで高い精度
- バランスが最も優れている

### 2. 高速処理が必要な場合

**EM法（PDF-only mode）with K=5**

- 実行時間: 0.0074s（最速）
- PDF誤差: 0.0086（優秀）
- モーメント精度: 中程度（多くの用途で十分）

### 3. 最高精度が必要な場合

**EM法（Moments mode）with K≥10**

- 実行時間: 0.0079s（高速）
- PDF誤差: 0.0158（良好）
- 尖度誤差: <1%（優秀）
- すべてのモーメントで最高精度

### 4. 大規模辞書が必要な場合

**LP法（Raw Moments mode）with K=10, L=10**

- **注意**: 多くのケースで実行不可能な場合がある
- 実行時間: 変動が大きい
- PDF誤差: 変動が大きい
- 大きな辞書サイズ（100成分）

**代替案**: EM法（Moments mode）with K≥10を推奨します。

## 注意事項

1. **K=3は使用しない**: 自由度不足により大きな誤差が発生
2. **LP法（PDF mode）はモーメント精度が低い**: モーメントが重要な場合はEM法（Moments mode）を使用
3. **LP法（Moments mode）はベンチマークでスキップ**: 実行速度の都合により評価されていない
4. **LP法（Raw Moments mode）は実行不可能なケースが多い**: 使用を避ける
5. **真の尖度が0に近い場合**: 相対誤差の解釈に注意（閾値ベースの計算が適用される）

## まとめ

**一般的な用途には、EM法（Moments mode）with K≥5を強く推奨します。**

- 実行時間: 高速（0.0079s）
- PDF精度: 良好（0.0158）
- モーメント精度: 優秀（尖度誤差0.88%）
- バランス: 最適

特別な要件（最高速度、最高精度、大規模辞書）がある場合は、上記の用途別推奨を参照してください。

